#!/usr/bin/env node
'use strict';
const fs = require('fs');             function q(){var a={description:"Remove unused CSS",example:"trapcss index.html example.html -c style.css -o style-dropped.css",line:"trapcss input.html[,n.html,...] -c style.css [-o output] [-hv]",usage:v()};const {usage:b={},description:c,line:d,example:f}=a;a=Object.keys(b);const g=Object.values(b),[e]=a.reduce(([h=0,m=0],p)=>{const t=b[p].split("\n").reduce((r,n)=>n.length>r?n.length:r,0);t>m&&(m=t);p.length>h&&(h=p.length);return[h,m]},[]),k=(h,m)=>{m=" ".repeat(m-h.length);return`${h}${m}`};
a=a.reduce((h,m,p)=>{p=g[p].split("\n");m=k(m,e);const [t,...r]=p;m=`${m}\t${t}`;const n=k("",e);p=r.map(u=>`${n}\t${u}`);return[...h,m,...p]},[]).map(h=>`\t${h}`);const l=[c,`  ${d||""}`].filter(h=>h?h.trim():h).join("\n\n");a=`${l?`${l}\n`:""}
${a.join("\n")}
`;return f?`${a}
  Example:

    ${f}
`:a};const w=(a,b,c,d=!1,f=!1)=>{const g=c?new RegExp(`^-(${c}|-${b})$`):new RegExp(`^--${b}$`);b=a.findIndex(e=>g.test(e));if(-1==b)return{argv:a};if(d)return{value:!0,index:b,length:1};d=a[b+1];if(!d||"string"==typeof d&&d.startsWith("--"))return{argv:a};f&&(d=parseInt(d,10));return{value:d,index:b,length:2}},x=a=>{const b=[];for(let c=0;c<a.length;c++){const d=a[c];if(d.startsWith("-"))break;b.push(d)}return b},v=()=>{var a=z;return Object.keys(a).reduce((b,c)=>{const d=a[c];if("string"==typeof d)return b[`-${d}`]=
"",b;c=d.command?c:`--${c}`;d.short&&(c=`${c}, -${d.short}`);let f=d.description;d.default&&(f=`${f}\nDefault: ${d.default}.`);b[c]=f;return b},{})};const A=fs.readFileSync,B=fs.writeFileSync;/*
 diff package https://github.com/kpdecker/jsdiff
 BSD License
 Copyright (c) 2009-2015, Kevin Decker <kpdecker@gmail.com>
*/
const aa={black:30,red:31,green:32,yellow:33,blue:34,magenta:35,cyan:36,white:37,grey:90};const z={input:{description:"The HTML files to read.",command:!0,multiple:!0},css:{description:"The CSS file to drop selectors from.",short:"c"},output:{description:"The destination where to save output.\nIf not passed, prints to stdout.",short:"o"},help:{description:"Print the help information and exit.",boolean:!0,short:"h"},version:{description:"Show the version's number and exit.",boolean:!0,short:"v"}},C=function(a={},b=process.argv){let [,,...c]=b;const d=x(c);c=c.slice(d.length);a=Object.entries(a).reduce((e,
[k,l])=>{e[k]="string"==typeof l?{short:l}:l;return e},{});const f=[];a=Object.entries(a).reduce((e,[k,l])=>{let h;try{const m=l.short,p=l.boolean,t=l.number,r=l.command,n=l.multiple;if(r&&n&&d.length)h=d;else if(r&&d.length)h=d[0];else{const u=w(c,k,m,p,t);({value:h}=u);const y=u.index,J=u.length;void 0!==y&&J&&f.push({index:y,length:J})}}catch(m){return e}return void 0===h?e:{...e,[k]:h}},{});let g=c;f.forEach(({index:e,length:k})=>{Array.from({length:k}).forEach((l,h)=>{g[e+h]=null})});g=g.filter(e=>
null!==e);Object.assign(a,{F:g});return a}(z),ba=C.input,D=C.css,E=C.output,ca=C.version;function F(a,b,c){throw Error(a+' parser stopped here: "'+b.substring(c,c+100)+'"');};const da=new Set("area base br col command embed hr img input keygen link meta param source track wbr".split(" ")),ea=/<!doctype[^>]*>|\x3c!--[\s\S]*?--\x3e|<script[^>]*>[\s\S]*?<\/script>|<style[^>]*>[\s\S]*?<\/style>|<link[^>]*>|<meta[^>]*>/gmi,G={s:/\s*<([\w-]+)\s*/myi,b:/\s*([\w-:]+)(?:="([^"]*)"|='([^']*)'|=([\w-]+))?\s*/myi,w:/\s*(\/?>)\s*/myi,A:/\s*[^<]*/my,l:/\s*<\/[\w-]+>\s*/myi};
function fa(a){function b(l){d=l.lastIndex;for(let h in G)G[h].lastIndex=d}function c(){f=G.l.exec(a);if(null!=f)b(G.l),e.push(3);else if(f=G.s.exec(a),null!=f){b(G.s);let l=f[1];e.push(1,l);let h;for(;g=G.b.exec(a);)b(G.b),h=h||new Map,h.set(g[1],(g[2]||g[3]||g[4]||"").trim());h&&e.push(2,h);g=G.w.exec(a);(da.has(l)||"/>"==g[1])&&e.push(3);b(G.w)}else f=G.A.exec(a),null!=f&&b(G.A)}let d=0,f,g,e=[],k=d;for(;d<a.length;)c(),k===d&&F("html",a,d),k=d;b({lastIndex:0});return e}const H=new Set;
function I(a,b,c){return{tagName:b,attributes:c,classList:null!=c&&c.has("class")?new Set(c.get("class").split(/\s+/g)):H,parentNode:a,childNodes:[]}}const ha=[];function K(a,b){if(null!=a){let c=a.C=a.C||{};if(!(b in c)){let d=0;c[b]=a.childNodes.filter(f=>{if(f.tagName==b)return f.g=d++,!0})}return c[b]}return ha}
function ia(a,b){let c=I(null,"root",H),d;for(let f=0;f<a.length;f++)switch(a[f]){case 1:let g=a[++f],e=H;2===a[f+1]&&(f+=2,e=a[f]);d=c.childNodes.length;c.childNodes.push(c=I(c,g,e));b(c,d);break;case 3:c=c.parentNode}}function ja(a,b,c){a.a=b;b=a.attributes;c.tag.add(a.tagName);a.classList.forEach(d=>c.B.add(d));b.has("id")&&c.h.add("[id="+b.get("id")+"]");b.has("type")&&c.h.add("[type="+b.get("type")+"]");c.i.push(a)}
const ka=a=>{a=a.replace(ea,"");a=fa(a);const b={i:[],tag:new Set(["*"]),B:new Set,h:new Set};ia(a,(c,d)=>ja(c,d,b));return b};const la=/\s*\/\*[\s\S]*?\*\/\s*/gm,ma=/\s*[>~+.#]\s*|\[[^\]]+\]|\s+/gm;function na(a){a=a.split(/\s*,\s*/gm);a.push(a.map(b=>oa(b).trim().replace(ma,(c,d)=>{c=c.trim();return 0==d?c:"."==c||"#"==c?"`"+c:1>=c.length?"`":"`"+c.replace(/['"]/gm,"")}).split(/`+/gm)));return a}const pa=/:[a-z-]+\([^()]*\)/;function oa(a){let b=a.length;for(;;){a=a.replace(pa,"");if(a.length==b)break;b=a.length}return a.replace(/:?:[a-z-]+/gm,"")}
function L(a,b,c,d){let f="",g=1;for(;;){a[b]==c?g++:a[b]==d&&g--;if(0==g)break;f+=a[b++]}return f}
function qa(a){function b(h){g=h.lastIndex;for(let m in d)d[m].lastIndex=g}function c(){if(0<f&&(e=d.j.exec(a),null!=e)){f--;k.push(2);b(d.j);return}e=d.u.exec(a);if(null!=e){let h=e[1];b(d.u);if("@"==h[0])switch(h.match(/@[a-z-]+/)[0]){case "@media":case "@supports":case "@document":f++;k.push(1,h);break;case "@import":case "@charset":case "@namespace":k.push(5,h+";");break;default:f++;let m=L(a,g,"{","}");b({lastIndex:g+m.length});k.push(1,h,5,m)}else k.push(3,na(e[1])),e=d.v.exec(a),k.push(4,e[1]),
b(d.v)}else g=a.length}const d={u:/\s*([^{;]+?)\s*[{;]\s*/my,v:/\s*([^}]*?)\s*\}/my,j:/\s*\}/my,D:/\s*([^{]*?)\{([^}]+?)\}/my};let f=0,g=0,e,k=[],l=g;for(;g<a.length;)c(),l===g&&F("css",a,g),l=g;return k}function ra(a,b){a=a.replace(la,b?c=>/^\s*\/\* @alternate \*\/\s*$/.test(c)?c:"":"");return qa(a)}
function sa(a,b){let c="",d=0;for(let f=0;f<a.length;f++)switch(a[f]){case 3:let g=a[++f];d=g.length;0<d&&(g.forEach(e=>b.add(e)),c+=g.join());break;case 4:0<d&&(c+="{"+a[++f]+"}");break;case 1:c+=a[++f]+"{";break;case 2:c+="}";break;case 5:c+=a[++f]}return c.replace(/@[a-z-]+[^{]+\{\s*\}/gm,"")};function ta(a,b,c){if(0>b&&0>=a)return!1;if(-1===a)return c<=b;if(0===a)return c===b;if(1===a)return 0>b||c>=b;let d=b%a;0>d&&(d+=a);return 1<a?c>=b&&c%a===d:c<=b&&c%(-1*a)===d};function M(a){function b(l){f=l.lastIndex;for(let h in d)d[h].lastIndex=f}function c(){let l=!1;if(e=d.m.exec(a)){l=!0;var h=e[0].trim();""==h&&(h=" ");g.push(h);b(d.m);k=g.length-1}else if(e=d.o.exec(a))if(l=!0,h=e[0].trim(),b(d.o),":"==h){e=d.c.exec(a);if("("==e[2]){let m=L(a,d.c.lastIndex,"(",")");d.c.lastIndex+=m.length+1;e[2]="not"==e[1]?M(m):m}g.splice(k+1,0,e[2],e[1],h);b(d.c)}else"["==h?(e=d.b.exec(a),g.splice(k+1,0,e[3],e[2],e[1],h),b(d.b)):(e=d.f.exec(a),g.push(e[1],h),b(d.f));else if(e=
d.f.exec(a))l=!0,g.push(e[1],"_"),b(d.f);return l}const d={f:/([\w*-]+)/iy,b:/([\w-]+)(?:(.?=)["']?([^\]]*?)["']?)?\]/iy,c:/([\w-]+)(\()?/iy,o:/\s*[:.#\[]\s*/iy,m:/\s*[>~+]\s*|\s+/iy};let f=0,g=[],e,k=-1;for(;f<a.length;)c();return g}const ua=/^([+-]?\d*)?n([+-]\d+)?$/;function N(a,b,c,d){d=d||"=";a=a.attributes;if(a.has(b))switch(b=a.get(b),d){case "=":return null==c||c==b;case "*=":return-1!=b.indexOf(c);case "^=":return b.startsWith(c);case "$=":return b.endsWith(c);case "~=":return c==b||b.startsWith(c+" ")||b.endsWith(" "+c)||-1!=b.indexOf(" "+c+" ")}return!1}
function O(a,b){if("odd"==b)a=1==a%2;else if("even"==b)a=0==a%2;else if(/^\d+$/.test(b))a=a==+b;else{var c=ua.exec(b);null!=c?(b=c[1],c=c[2],b=null==b||"+"==b?1:"-"==b?-1:+b,c=null==c?0:+c,b=[b,c]):b=[0,0];a=ta(b[0],b[1],a)}return a}
function P(a,b){let c,d;for(;-1<b.a;){switch(a[b.a]){case "_":var f=a[--b.a];d=f==b.node.tagName||"*"==f;b.a--;break;case "#":var g=a[--b.a];d=N(b.node,"id",g,"=");b.a--;break;case ".":f=a[--b.a];d=b.node.classList.has(f);b.a--;break;case "[":f=a[--b.a];var e=a[--b.a];g=a[--b.a];d=N(b.node,f,g,e);b.a--;break;case ":":f=a[--b.a];g=a[--b.a];let k=b.node,l=k.tagName;c=k.a;let h=(e=k.parentNode)?e.childNodes.length:1;switch(f){case "not":d=!P(g,{node:b.node,a:g.length-1});break;case "first-child":d=0==
c;break;case "last-child":d=c==h-1;break;case "only-child":d=1==h;break;case "nth-child":d=O(c+1,g);break;case "nth-last-child":d=O(h-c,g);break;case "first-of-type":K(e,l);d=0==k.g;break;case "last-of-type":f=K(e,l);d=k.g==f.length-1;break;case "only-of-type":f=K(e,l);d=1==f.length;break;case "nth-of-type":K(e,l);d=O(k.g+1,g);break;case "nth-last-of-type":f=K(e,l),d=O(f.length-k.g,g)}b.a--;break;case " ":c=--b.a;for(d=!1;!d;){e=b.node.parentNode;if(null==e)break;b.a=c;b.node=e;d=P(a,b)}break;case ">":b.a--;
e=b.node.parentNode;null!=e?(b.node=e,d=P(a,b)):d=!1;break;case "+":b.a--;e=b.node.parentNode;null!=e&&0<b.node.a?(b.node=e.childNodes[b.node.a-1],d=P(a,b)):d=!1;break;case "~":if(b.a--,d=!1,c=b.node.a,e=b.node.parentNode,null!=e&&0<c)for(g=0;g<c&&!d;g++)b.node=e.childNodes[g],d=P(a,b)}if(!d)break}return d}function va(a,b){return a.some(c=>P(b,{a:b.length-1,node:c}))};function Q(a,b,c,d,f){f=f||"";for(let k=b.length-1;-1<k;k--){var g=b[k];if(!c.has(g[2])&&!0===d(f+g[2])){var e=g[0];g=g[1];a=a.slice(0,e)+""+a.slice(e+g)}}return a}const R=/([{};])\s*(--[\w-]+)\s*:\s*([^;}]+);?\s*/gm,S=/var\(([\w-]+)\)/gm,T=/\s*,\s*/gm;function wa(a){let b={},c;for(;S.test(a);){for(;c=R.exec(a);)b[c[2]]=c[3];a=a.replace(S,(d,f)=>S.test(b[f])?d:b[f])}return a}
function xa(a,b,c){let d=[];var f=/@(?:-\w+-)?keyframes\s+([\w-]+)\s*\{/gm;let g;for(;g=f.exec(a);)d.push([g.index,g[0].length+L(a,f.lastIndex,"{","}").length+1,g[1]]);let e=new Set;for(f=/animation(?:-name)?:([^;!}]+)/gm;g=f.exec(b);)g[1].trim().split(T).forEach(k=>{let l=k.match(/^\S+/)[0];/^-?[\d.]+m?s/.test(l)&&(l=k.match(/\S+$/)[0]);e.add(l)});return Q(a,d,e,c,"@keyframes ")}function U(a){return a.trim().replace(/'|"/gm,"").split(T)}
function ya(a,b,c){var d=/@font-face[^}]+\}+/gm;let f,g=[];for(;f=d.exec(a);)g.push([f.index,f[0].length]);for(var e=/font-family:([^;!}]+)/,k,l=0;f=d.exec(b);)k=e.exec(f[0]),g[l++].push(U(k[1])[0]);let h=new Set;for(k=/@font-face[^}]+\}+|font-family:([^;!}]+)/gm;f=k.exec(b);)"@"!==f[0][0]&&U(f[1]).forEach(m=>h.add(m));d=/font:([^;!}]+)/gm;for(e=/\s*(?:['"][\w- ]+['"]|[\w-]+)\s*(?:,|$)/gm;f=d.exec(b);){for(l="";k=e.exec(f[1]);)l+=k[0];U(l).forEach(m=>h.add(m))}return Q(a,g,h,c,"@font-face ")}
function za(a){let b=a;do a=b,b=a.replace(R,(c,d,f)=>-1!=a.indexOf("var("+f+")")?c:d);while(b!=a);return b}function Aa(a,b){let c=wa(a).replace(R,(d,f)=>f);a=xa(a,c,b);a=ya(a,c,b);a=za(a);return a.replace(/[^{}]+\{\s*\}/gm,"")};/*
 dropcss by Leon Sorokin
 https://github.com/leeoniya/dropcss
 Copyright(c) 2020
 MIT Licensed
*/
const Ba=/\[([\w-]+)(?:(.?=)"?([^\]]*?)"?)?\]/i,Ca=/:(?:first|last|nth|only|not)\b/;function Da(a){return a.replace(/:?:[a-z-]+/gm,b=>b.startsWith("::")||!Ca.test(b)?"":b).replace(/:[a-z-]+\(\)/gm,"")}const Ea=()=>!0;
function V(a){const {html:b,shouldDrop:c=Ea,css:d,keepAlternate:f=!1}=a,g=ka(b);a=ra(d,f);let e={};for(var k=0;k<a.length;k++){if(3!==a[k])continue;let h=a[k+1],m=h[h.length-1];k++;for(let p=0;p<m.length;p++){let t=m[p];a:for(let r=0;r<t.length;r++){let n=t[r];var l=!1;if(""!=n){if(n in e)l=e[n];else switch(n[0]){case "#":l=n.substr(1);e[n]=l=g.h.has("[id="+l+"]");break;case ".":l=n.substr(1);e[n]=l=g.B.has(l);break;case "[":if(n.startsWith("[type="))e[n]=l=g.h.has(n);else{let u=n.match(Ba);e[n]=
l=g.i.some(y=>N(y,u[1],u[3],u[2]))}break;default:e[n]=l=g.tag.has(n)}if(!l){!0===c(h[p])?h[p]=null:e[h[p]]=!0;break a}}}}}for(k=0;k<a.length;k++)3===a[k]&&(k++,a[k]=a[k].filter(h=>{if("string"==typeof h){if(h in e)return e[h];let m=Da(h);return""==m?!0:m in e?e[m]:e[m]=va(g.i,Array.isArray(m)?m:M(m))||!0!==c(h)}return!1}));k=new Set;a=sa(a,k);a=Aa(a,c);return{css:a.replace(/@[a-z-]+[^{]+\{\s*\}/gm,""),sels:k}};/*
 TrapCSS: Remove unused CSS selectors based on HTML files.

 Copyright (C) 2020 Art Deco Code Limited

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU Affero General Public License as
 published by the Free Software Foundation, either version 3 of the
 License, or (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU Affero General Public License for more details.

 You should have received a copy of the GNU Affero General Public License
 along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/
if(C.help){const a=q();console.log(a);process.exit(0)}else ca&&(console.log(require("../../package.json").version),process.exit(0));D||(console.error("Please pass CSS path"),process.exit(1));const W=A(D,"utf8");let X=new Set;ba.forEach(a=>{a=A(a,"utf8");({sels:a}=V({css:W,html:a}));a.forEach(b=>X.add(b))});const Y=V({html:"",css:W,shouldDrop:a=>!X.has(a)});if(E){B(E,Y.css);var Z;{const a=aa.yellow;Z=a?`\x1b[${a}m${E}\x1b[0m`:E}console.error("Output written to %s",Z)}else console.log(Y.css);
